<!DOCTYPE html>
<html>
<head>
    <title>Cosmic Miner</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial; 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white; 
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .card { 
            background: rgba(255,255,255,0.1); 
            border-radius: 15px; 
            padding: 15px; 
            margin-bottom: 15px;
        }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .resources { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0; }
        .btn { 
            background: #4CAF50; 
            border: none; 
            border-radius: 10px; 
            color: white; 
            padding: 15px; 
            font-size: 16px; 
            cursor: pointer; 
            width: 100%;
            margin: 5px 0;
        }
        .btn:hover { opacity: 0.9; }
        .btn-mine { background: #FF6B6B; }
        .btn-sell { background: #4ECDC4; }
        .btn-upgrade { background: #FFD93D; color: black; }
        .resource { text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; }
        #message { margin-top: 20px; text-align: center; padding: 10px; border-radius: 10px; }
        .success { background: rgba(76, 175, 80, 0.3); }
        .error { background: rgba(244, 67, 54, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Cosmic Miner</h1>
            <p>–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –¥–æ–±—ã—á–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</p>
        </div>
        
        <div class="card">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
            <div class="stats">
                <div>üí∞ –ö—Ä–µ–¥–∏—Ç—ã:</div>
                <div id="credits">100</div>
                <div>üöÄ –£—Ä–æ–≤–µ–Ω—å –∫–æ—Ä–∞–±–ª—è:</div>
                <div id="shipLevel">1</div>
            </div>
        </div>
        
        <div class="card">
            <h3>–†–µ—Å—É—Ä—Å—ã:</h3>
            <div class="resources">
                <div class="resource">ü™® –ñ–µ–ª–µ–∑–æ: <span id="iron">0</span></div>
                <div class="resource">üì¶ –ó–æ–ª–æ—Ç–æ: <span id="gold">0</span></div>
                <div class="resource">üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã: <span id="crystals">0</span></div>
            </div>
        </div>
        
        <button class="btn btn-mine" onclick="mine()">‚õè –î–æ–±—ã–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã</button>
        <button class="btn btn-upgrade" onclick="upgrade()">üõ† –£–ª—É—á—à–∏—Ç—å –∫–æ—Ä–∞–±–ª—å</button>
        
        <button class="btn btn-sell" onclick="sell('iron')">üõí –ü—Ä–æ–¥–∞—Ç—å –∂–µ–ª–µ–∑–æ (2üí∞)</button>
        <button class="btn btn-sell" onclick="sell('gold')">üõí –ü—Ä–æ–¥–∞—Ç—å –∑–æ–ª–æ—Ç–æ (5üí∞)</button>
        <button class="btn btn-sell" onclick="sell('crystals')">üõí –ü—Ä–æ–¥–∞—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã (15üí∞)</button>
        
        <div id="message"></div>
    </div>

    <script>
        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let user = { id: 'test_user_' + Math.random().toString(36).substr(2, 9) };
        let baseUrl = window.location.origin;
        
        // –ï—Å–ª–∏ –≤ Telegram, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if (window.Telegram && Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            user = tg.initDataUnsafe.user || { id: 'telegram_user' };
            tg.expand();
            console.log('Telegram Web App initialized');
        }
        
        console.log('Base URL:', baseUrl);
        console.log('User ID:', user.id);
        
        async function loadGame() {
            try {
                showMessage('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...', 'success');
                const response = await fetch(`${baseUrl}/api/player/${user.id}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                updateDisplay(data);
                showMessage('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
            } catch (error) {
                console.error('Error loading game:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
            }
        }
        
        async function mine() {
            try {
                showMessage('–î–æ–±—ã–≤–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã...', 'success');
                const response = await fetch(`${baseUrl}/api/mine`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user.id })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateDisplay(result.player);
                    showMessage(`–î–æ–±—ã—Ç–æ: +${result.resources.iron}ü™® +${result.resources.gold}üì¶ +${result.resources.crystals}üíé`, 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Mining error:', error);
                showMessage('–û—à–∏–±–∫–∞ –¥–æ–±—ã—á–∏: ' + error.message, 'error');
            }
        }
        
        async function sell(resourceType) {
            try {
                const response = await fetch(`${baseUrl}/api/sell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: user.id, 
                        resource_type: resourceType 
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateDisplay(result.player);
                    showMessage(`–ü—Ä–æ–¥–∞–Ω–æ! +${result.income}üí∞`, 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Selling error:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏: ' + error.message, 'error');
            }
        }
        
        async function upgrade() {
            try {
                const response = await fetch(`${baseUrl}/api/upgrade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user.id })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateDisplay(result.player);
                    showMessage(`–ö–æ—Ä–∞–±–ª—å —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è ${result.new_level}! üöÄ`, 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Upgrade error:', error);
                showMessage('–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        function updateDisplay(player) {
            document.getElementById('credits').textContent = player.credits;
            document.getElementById('shipLevel').textContent = player.ship_level;
            document.getElementById('iron').textContent = player.resources.iron;
            document.getElementById('gold').textContent = player.resources.gold;
            document.getElementById('crystals').textContent = player.resources.crystals;
        }
        
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = type || '';
            setTimeout(() => messageEl.textContent = '', 3000);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–≥—Ä—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', function() {
            loadGame();
        });
    </script>
</body>
</html>
